<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Items</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 12px; }
    h1 { margin-bottom: 8px; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    label { display:block; font-size: 13px; margin-bottom:4px; }
    input, textarea { width:100%; padding:8px; box-sizing:border-box; }
    textarea { min-height:72px; resize:vertical; }
    button { padding:8px 12px; margin-top: 20px; }
    .controls { display:flex; gap:8px; align-items:flex-end; }
    .msg { margin:8px 0; padding:8px; border-radius:4px; }
    .msg.success { background:#e6ffed; border:1px solid #b7f2c9; }
    .msg.error { color:red; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f7f7f7; }
    .inline { display:inline-flex; gap:8px; align-items:center; }
    .small { font-size:13px; color:#555; }
  </style>
</head>
<body>
  <h1>Items</h1>

  <section aria-labelledby="add-heading">
    <h2 id="add-heading">Add Item</h2>
    <form id="add-form">
      <div id="add-msg" class="msg" style="display:none; grid-column:1 / -1;"></div>
      <div>
        <label for="name">Name</label>
        <input id="name" name="name" required />
        <div id="add-msg-name" class="msg" style="display:none; grid-column:1 / -1;"></div>
      </div>
      <div>
        <label for="price">Price</label>
        <input id="price" name="price" type="number" step="any" />
        <div id="add-msg-price" class="msg" style="display:none; grid-column:1 / -1;"></div>
      </div>
      <div style="grid-column:1 / -1">
        <label for="description">Description</label>
        <textarea id="description" name="description"></textarea>
         <div id="add-msg-description" class="msg" style="display:none; grid-column:1 / -1;"></div>
      </div>
      <div class="controls" style="grid-column:1 / -1">
        <button type="submit">Add Item</button>
      </div>
    </form>
    
  </section>

  <section aria-labelledby="search-heading" style="margin-top:18px">
    <h2 id="search-heading">Search by ID</h2>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="search-id" placeholder="Enter item id" />
      <button id="search-btn">Search</button>
      <button id="clear-search">Clear</button>
    </div>
    <div id="search-result" style="margin-top:8px"></div>
  </section>

  <section aria-labelledby="list-heading" style="margin-top:18px">
    <h2 id="list-heading">All Items</h2>
    <div id="list-msg" class="msg" style="display:none;"></div>
    <div id="items-container"></div>
  </section> 

  <script>
    const BASE_URL = 'https://jubilant-funicular-56a9.onrender.com';
    const addForm = document.getElementById('add-form');
    const addMsg = document.getElementById('add-msg');
    const addMsgName = document.getElementById('add-msg-name');
    const addMsgPrice = document.getElementById('add-msg-price');
    const addMsgDescription = document.getElementById('add-msg-description');
    const listMsg = document.getElementById('list-msg');
    const itemsContainer = document.getElementById('items-container');




    function showMessage(el, text, ok = true) {
      el.textContent = text;
      el.className = ok ? 'msg success' : 'msg error';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }



    async function fetchAllItems() {
      itemsContainer.innerHTML = '<div class="small">Loading...</div>';
      try {
        const res = await fetch(BASE_URL + '/items/all');
        if (!res.ok) throw new Error('Failed to fetch: ' + res.status);
        const items = await res.json();
        renderItems(items);
      } catch (err) {
        itemsContainer.innerHTML = '';
        showMessage(listMsg, 'Error loading items: ' + err.message, false);
      }
    }


    
    function renderItems(items) {
      if (!Array.isArray(items) || items.length === 0) {
        itemsContainer.innerHTML = '<div class="small">Empty List</div>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>Id</th><th>Name</th><th>Description</th><th>Price</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.id ?? ''}</td>
          <td>${escapeHtml(item.name ?? '')}</td>
          <td>${escapeHtml(item.description ?? '')}</td>
          <td>${item.price ?? ''}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      itemsContainer.innerHTML = '';
      itemsContainer.appendChild(table);
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }

    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        name: document.getElementById("name").value,
        description: document.getElementById("description").value,
        price: document.getElementById("price").value
            ? parseInt(document.getElementById("price").value)
            : null
    };

      try {
        const res = await fetch(BASE_URL + '/items/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(res.status + ' ' + text);
        }
        const created = await res.json();
        showMessage(addMsg, 'Item added with id ' + (created.id ?? '(unknown)'), true);
        addForm.reset();
        fetchAllItems();
      } catch (err) {
        let error = JSON.parse(err.message.replace(/^[0-9]+ /, ''));
        
        const nameErr = error.errors?.name ? 'Name: ' + error.errors.name : '';
        const priceErr = error.errors?.price ? 'Price: ' + error.errors.price : '';
        const descriptionErr = error.errors?.description ? 'Description: ' + error.errors.description : '';


        if(nameErr){
          showMessage(addMsgName, '*' + nameErr , false);
        }else{
            addMsgName.style.display = 'none';}

        
        if(priceErr){
          showMessage(addMsgPrice, '*' + priceErr , false);
        }
        else{
            addMsgPrice.style.display = 'none';
          }


        if(descriptionErr){
          showMessage(addMsgDescription, '*' + descriptionErr , false);
        }
          else{
            addMsgDescription.style.display = 'none';
          }
      }
    });

    // Search by id
    document.getElementById('search-btn').addEventListener('click', async () => {
      const id = document.getElementById('search-id').value.trim();
      const out = document.getElementById('search-result');
      out.innerHTML = '';
      if (!id) { out.textContent = 'Please enter an id.'; return; }
      try {
        const res = await fetch(BASE_URL + '/items/' + encodeURIComponent(id));
        if (res.status === 404) {
          out.innerHTML = '<div class="small">Item not found.</div>';
          return;
        }
        if (!res.ok) throw new Error('Error: ' + res.status);
        const item = await res.json();
        out.innerHTML = `
          <table><thead><tr><th>Id</th><th>Name</th><th>Description</th><th>Price</th></tr></thead>
          <tbody><tr>
            <td>${item.id ?? ''}</td>
            <td>${escapeHtml(item.name ?? '')}</td>
            <td>${escapeHtml(item.description ?? '')}</td>
            <td>${item.price ?? ''}</td>
          </tr></tbody></table>
        `;
      } catch (err) {
        out.textContent = '<div class="small">Error fetching item: ' + escapeHtml(err.message) + '</div>';
      }
    });

    document.getElementById('clear-search').addEventListener('click', () => {
      document.getElementById('search-id').value = '';
      document.getElementById('search-result').innerHTML = '';
    });

    // initial load
    fetchAllItems();
  </script>

</body>
</html>